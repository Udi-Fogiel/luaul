name: Release

on:
  push:
    tags: "*"

jobs:
  l3build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install TeX Live
        uses: zauguin/install-texlive@v3
        with:
          package_file: .github/tl_packages
      - name: Run l3build
        run: l3build ctan --show-log-on-error -H
      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: Package
          path: "build/distrib/ctan/*.zip"

  github:
    runs-on: ubuntu-22.04
    needs:
      - l3build
    steps:
      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: Package
      - name: Create GitHub release
        uses: ncipollo/release-action@2c591bcc8ecdcd2db72b97d6147f871fcd833ba5
        with:
          artifacts: "*.zip"
          token: ${{ secrets.GITHUB_TOKEN }}

  ctan-validate:
    runs-on: ubuntu-22.04
    needs:
      - l3build
    steps:
      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: Package
      - name: Upload CTAN package
        uses: zauguin/ctan-upload@v0.1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          package-name: lua-ul
          version: ${{ github.ref_name }}
          author: Marcel Krüger
          uploader: Dummy Name
          email: dryrun@example.com
          license: lppl1.3c
          summary: Underlining for LuaLaTeX
          ctan-path: /macros/luatex/latex/lua-ul
          update: true
          topic: underline,luatex
          description: |
             This package provides underlining, strikethough, and highlighting using features in LuaLaTeX which avoid the restrictions imposed by other methods. In particular, kerning is not affected, the underlined text can use arbitrary commands, hyphenation works etc.

             The package requires LuaTeX version ≥ 1.12.0. 
          filename: lua-ul-ctan.zip
          dry-run: true
